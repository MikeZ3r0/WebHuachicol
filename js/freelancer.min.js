/*!
 * Start Bootstrap - Freelancer v5.0.3 (https://startbootstrap.com/template-overviews/freelancer)
 * Copyright 2013-2019 Start Bootstrap
 * Licensed under MIT (https://github.com/BlackrockDigital/startbootstrap-freelancer/blob/master/LICENSE)
 */

!function(t){"use strict";t('a.js-scroll-trigger[href*="#"]:not([href="#"])').click(function(){if(location.pathname.replace(/^\//,"")==this.pathname.replace(/^\//,"")&&location.hostname==this.hostname){var o=t(this.hash);if((o=o.length?o:t("[name="+this.hash.slice(1)+"]")).length)return t("html, body").animate({scrollTop:o.offset().top-70},1e3,"easeInOutExpo"),!1}}),t(document).scroll(function(){100<t(this).scrollTop()?t(".scroll-to-top").fadeIn():t(".scroll-to-top").fadeOut()}),t(".js-scroll-trigger").click(function(){t(".navbar-collapse").collapse("hide")}),t("body").scrollspy({target:"#mainNav",offset:80});var o=function(){100<t("#mainNav").offset().top?t("#mainNav").addClass("navbar-shrink"):t("#mainNav").removeClass("navbar-shrink")};o(),t(window).scroll(o),t(".portfolio-item").magnificPopup({type:"inline",preloader:!1,focus:"#username",modal:!0}),t(document).on("click",".portfolio-modal-dismiss",function(o){o.preventDefault(),t.magnificPopup.close()}),t(function(){t("body").on("input propertychange",".floating-label-form-group",function(o){t(this).toggleClass("floating-label-form-group-with-value",!!t(o.target).val())}).on("focus",".floating-label-form-group",function(){t(this).addClass("floating-label-form-group-with-focus")}).on("blur",".floating-label-form-group",function(){t(this).removeClass("floating-label-form-group-with-focus")})})}(jQuery);

$('.asignarSedena').click(function() {
    $('#ModalSedena').modal('hide');
    $('#ModalPemex').modal('show');
});

document.addEventListener('DOMContentLoaded', function () {
  cargarDatos();
  if (document.querySelectorAll('#mapa').length > 0)
  {
   /* var js_file = document.createElement('script');
    js_file.type = 'text/javascript';
    js_file.src = 'https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js';
    document.getElementsByTagName('head')[0].appendChild(js_file);
    var css_file = document.createElement('link');
    css_file.type = 'text/css';
    css_file.rel = 'stylesheet';
    css_file.href = 'https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css';
    css_file.media = 'screen';
    document.getElementsByTagName('head')[0].appendChild(css_file);
    */
    initMap();
    marcadores();
    verificarToken();
  }
});

var map = null;
var markers = [];
var locations = [];
var token = "";

function initMap() {
    //No es necesaria la linea si se trabaja con EPSG: 4326 como proyeccion
    //var centro = ol.proj.fromLonLat([-100,21]);
    var view = new ol.View({center: [-100,21], zoom: 4, minZoom:4, projection: 'EPSG:4326'});
    var overviewView = new ol.View({projection:'EPSG:4326'});
    map = new ol.Map({
        target: 'mapa',
        layers: [new ol.layer.Tile({
            preload: 4,
            source: new ol.source.OSM(),
            })
        ],
        loadThilesWhileAnimating: true,
        view: view
    });
    map.addControl(new ol.control.FullScreen());
    map.addControl(new ol.control.OverviewMap({view: overviewView}));
    map.addControl(new ol.control.ScaleLine());
}



var json = {"denuncias":[
    {"Folio":15,"Coordenadas":"19.4440685, -99.1418708","Descripcion":"Fuga en tuberia","Status":"En proceso","Distancia":"verde","Accion":"true"},
    {"Folio":17,"Coordenadas":"19.559797, -99.0500927","Descripcion":"Sabotaje","Status":"En proceso","Distancia":"amarillo","Accion":"true"},
    {"Folio":21,"Coordenadas":"19.835556, -98.9352197","Descripcion":"Robo de combustible","Status":"Finalizado","Distancia":"rojo","Accion":"true"},
    {"Folio":30,"Coordenadas":"28.060944, -105.364325","Descripcion":"Fuga en tuberia","Status":"En espera","Distancia":"amarillo","Accion":"true"},
    {"Folio":42,"Coordenadas":"27.278238, -104.950253","Descripcion":"Robo de combustible","Status":"Sin asignar","Distancia":"rojo","Accion":"true"},
    {"Folio":43,"Coordenadas":"25.761545, -108.814288","Descripcion":"Fuga en tuberia","Status":"En proceso","Distancia":"verde","Accion":"true"}
]};


function cargarDatos(){
    var DatosJason = JSON.parse(JSON.stringify(json));
    locations = [];
    $("#tablaDenuncias").append('<thead role="rowgroup"><tr role="row">'+
        '<th role="columnheader" class="fol">Folio</th>'+
        '<th role="columnheader" class="coo">Coordenadas</th>'+
        '<th role="columnheader" class="des">Descripción</th>'+
        '<th role="columnheader" class="sta">Status</th>'+
        '<th role="columnheader" class="dis">Distancia al ducto</th>'+
        '<th role="columnheader" class="acc">Acciones</th></tr></thead><tbody>');
    for (i = 0; i < DatosJason.denuncias.length; i++){
        $("#tablaDenuncias").append('<tr role="row">'+
            '<td role="cell">'+ DatosJason.denuncias[i].Folio +'</td>'+
            '<td role="cell" class="bcoordenadas">'+ DatosJason.denuncias[i].Coordenadas +'</td>'+
            '<td role="cell">'+ DatosJason.denuncias[i].Descripcion +'</td>'+
            '<td role="cell">'+ DatosJason.denuncias[i].Status +'</td>'+
            '<td role="cell"><div class='+ DatosJason.denuncias[i].Distancia + '></div></td>'+
            '<td role="cell"><div class="accion"><div class="asignar"><button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ModalSedena"></button></div>'+
            '<div class="eliminar"><button type="submit"></button></div></div></td></tr>'
        );
        var coord = DatosJason.denuncias[i].Coordenadas.split(",");
        var lat = parseFloat(coord[0]);
        var lng = parseFloat(coord[1]);
        var punto = {lat:lat,lng:lng};
        locations.push(punto);
    }
    $("#tablaDenuncias").append('</tbody>');
}

function verificarToken(){
    token = localStorage.getItem("token");
    if(typeof(token) === "undefined"){
        console.log("token no cargado: ",token);
    }
    else{
        console.log("token cargado: ",token);
    }
}



    $(".bcoordenadas").click(function(e){
        e.preventDefault();
        var fila = $(this).parents("tr").index();
        flyTo([locations[fila].lng,locations[fila].lat], function() {});
    });

    $("#finSesion").click(function(r){
        r.preventDefault();
        token = "";
        localStorage.removeItem("token");
        flyTo([locations[fila].lng,locations[fila].lat], function() {});
    });



function flyTo(location, done) {
        var duration = 2000;
        var view = map.getView();
        var zoom = view.getZoom();
        var mzoom = view.getMinZoom();
        var zoom2 = mzoom;
        if(zoom < 8){
            zoom2 = zoom-1;
            zoom = 7;
        }
        if(zoom > 10){
            zoom2 = zoom -2;
        }
        if(zoom > 14){
                    zoom2 = zoom - 4;
                }
        var parts = 2;
        var called = false;
        function callback(complete) {
          --parts;
          if (called) {
            return;
          }
          if (parts === 0 || !complete) {
            called = true;
            done(complete);
          }
        }
        view.animate({
          center: location,
          duration: duration
        }, callback);
        view.animate({
          zoom: zoom2,
          duration: duration / 2
        }, {
          zoom: zoom,
          duration: duration / 2
        }, callback);
}

function marcadores(){
    var vectorSource = new ol.source.Vector({});
    for(var i=0; i<locations.length;i++){
        var lng = locations[i].lng;
        var lat = locations[i].lat;
        var iconPath = 'img/personal/dis_green.png';
        var iconFeature = new ol.Feature({
            geometry: new ol.geom.Point([lng,lat])
        });
        var iconStyle = new ol.style.Style({
            image: new ol.style.Icon(/** @type {module:ol/style/Icon~Options} */ ({
                anchor: [0.5, 46],
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                src: iconPath,
                opacity: .5
            }))
        });
        iconFeature.setStyle(iconStyle);
        markers.push(iconFeature);
    }

    vectorSource.addFeatures(markers);
    var vectorLayer = new ol.layer.Vector({
        source: vectorSource
    });
    map.addLayer(vectorLayer);
    map.getView().setCenter([-99,19]);
}


$('#log input').jqBootstrapValidation({
    preventSubmit: true,
    submitSuccess: function($form, event){
        event.preventDefault();
        var response = "";
        var requestURL = 'https://auth-service-huachicol.herokuapp.com/oauth/token';
        $this = $('#logButton');
        $this.prop('disable',true); // Disable submit button until AJAX call is complete to prevent duplicate messages
        var data = {username:$("input#username").val(), password: $("input#pass").val(), grant_type: "password"};
        $.ajax({
            url: requestURL,
            data: data,
            method: 'post',
            dataType: 'json',
            headers:{
                'Content-Type': 'application/x-www-form-urlencoded',
                'Authorization': 'Basic '+ btoa("angularjwtclientid:12345")
            },
            cache: false,
            success: function() {
                // Success message
                $('#successlog').html("<div class='alert alert-success'>");
                $('#successlog > .alert-success').html("<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;")
                  .append("</button>");
                $('#successlog > .alert-success')
                  .append("<strong>Ingresando. </strong>");
                $('#successlog > .alert-success')
                  .append('</div>');
                //clear all fields
                $('#log').trigger("reset");
                $(location).attr('href', 'login.html')
            },
            error: function(response) {
                // Fail message
                $('#successlog').html("<div class='alert alert-danger'>");
                $('#successlog > .alert-danger').html("<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;")
                  .append("</button>");
                var error = response.responseJSON.error;
                console.log(error);
                if(error === "invalid_grant"){
                    $('#successlog > .alert-danger').append($("<strong>").text("Usuario y/o contraseña incorrecta"));
                }
                else if(error === "unauthorized"){
                    $('#successlog > .alert-danger').append($("<strong>").text("Problema para acceder al servidor (autorizacion)"));
                }
                else
                {
                    $('#successlog > .alert-danger').append($("<strong>").text("Problema con servidor"));
                }
                $('#successlog > .alert-danger').append('</div>');
                //clear all fields
                $('#pass').trigger("reset");
            },
            complete: function(response) {
                setTimeout(function() {
                  $this.prop("disabled", false); // Re-enable submit button when AJAX call is complete
                }, 1000);
                token = response.responseJSON.access_token;
                console.log('token: ',token);
                localStorage.setItem("token",token);
            }
        });
    },
    filter: function() {
        return $(this).is(":visible");
    },
});





